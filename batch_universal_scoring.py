# –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ë–ê–¢–ß-–°–ò–°–¢–ï–ú–ê –î–õ–Ø –õ–Æ–ë–û–ì–û –ö–û–õ–ò–ß–ï–°–¢–í–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ 180 –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞)
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞: pip install google-generativeai pandas openpyxl

import pandas as pd
import json
import time
import google.generativeai as genai
from datetime import datetime
import re

# ============ –ù–ê–°–¢–†–û–ô–ö–ò ============
import os
from dotenv import load_dotenv
load_dotenv()
GEMINI_API_KEY = os.getenv("GOOGLE_API_KEY_1")  # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ .env
MODEL = "gemini-2.5-flash-lite"
BATCH_SIZE = 180  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ
MAX_USERS = None   # –ú–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ–≥–æ (–º–æ–∂–µ—à—å —É–≤–µ–ª–∏—á–∏—Ç—å)

genai.configure(api_key=GEMINI_API_KEY)

print(f"ü§ñ –ú–æ–¥–µ–ª—å: {MODEL}")
print(f"üìä –ë–∞—Ç—á-—Ä–∞–∑–º–µ—Ä: {BATCH_SIZE} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∑–∞–ø—Ä–æ—Å–µ")
print(f"üìà –ú–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {MAX_USERS}\n")

# ============ –§–£–ù–ö–¶–ò–Ø –ë–ê–¢–ß –û–¶–ï–ù–ö–ò ============
def score_batch_users(batch_data, batch_number):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞—Ç—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ Gemini.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å {index: score}
    """
    
    batch_size = len(batch_data)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    users_text = ""
    for i, user in enumerate(batch_data, 1):
        name = str(user.get('–ò–º—è', '')).strip()
        surname = str(user.get('–§–∞–º–∏–ª–∏—è', '')).strip()
        description = str(user.get('–°—É–º–º–∞—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', '')).strip()
        
        if not description or description.lower() in ['nan', 'none', '']:
            description = "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"
        
        users_text += f"{i}. {name} {surname}\n   {description}\n\n"
    
    # –ü—Ä–æ–º–ø—Ç –¥–ª—è –±–∞—Ç—á–∞
    prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏—Ö {batch_size} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram –∏ –ø—Ä–∏—Å—É–¥–∏ –∫–∞–∂–¥–æ–º—É —Å–∫–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–∞ –¥–ª—è –≤–µ–±-–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –î–ú –õ–∏–¥—Å (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–æ–≤, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –ª–∏–¥-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) –æ—Ç 1 –¥–æ 100.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∏—Å–≤–æ–∏—Ç—å –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–∫–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–∞ –¥–ª—è –≤–µ–±‚Äë–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–æ–≤, –ª–µ–Ω–¥–∏–Ω–≥–∏, –ª–∏–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥) –æ—Ç 1 –¥–æ 100.

–û—Ü–µ–Ω–∏–≤–∞–π –ø–æ 5 —Ñ–∞–∫—Ç–æ—Ä–∞–º:

1) –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ –∏ –Ω–∏—à–∞ (0‚Äì30)
- 25‚Äì30: —Ü–∏—Ñ—Ä–æ–≤–æ–π –±–∏–∑–Ω–µ—Å, —Å–∏–ª—å–Ω–æ –∑–∞–≤—è–∑–∞–Ω–Ω—ã–π –Ω–∞ –æ–Ω–ª–∞–π–Ω–µ (IT, SaaS, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥/—Ä–µ–∫–ª–∞–º–∞, –ø—Ä–æ–¥—é—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, e‚Äëcommerce, –æ–Ω–ª–∞–π–Ω‚Äë–∫—É—Ä—Å—ã, —Å—Ç—É–¥–∏–∏ –¥–∏–∑–∞–π–Ω–∞).
- 15‚Äì24: —ç–∫—Å–ø–µ—Ä—Ç—ã –∏ —É—Å–ª—É–≥–∏ B2B/B2C (—é—Ä–∏—Å—Ç—ã, –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞, –∫–æ—É—á–∏, –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥, —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—ã, –º–µ–¥/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ —Ç.–ø.).
- 5‚Äì14: –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ñ–ª–∞–π–Ω‚Äë—É—Å–ª—É–≥–∏, –≥–¥–µ —Å–∞–π—Ç ‚Äî –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –∫–∞–Ω–∞–ª.
- 0‚Äì4: —Ö–æ–±–±–∏, –ª–∏—á–Ω—ã–µ –±–ª–æ–≥–∏, –º–µ–º—ã, –ø–æ–ª–∏—Ç–∏–∫–∞, —Å–µ—Ä—ã–µ/–Ω–µ–ª–µ–≥–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã.

2) –†–æ–ª—å —á–µ–ª–æ–≤–µ–∫–∞ (0‚Äì25)
- 20‚Äì25: –≤–ª–∞–¥–µ–ª–µ—Ü, —Å–æ–æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å, –¥–∏—Ä–µ–∫—Ç–æ—Ä, –ò–ü, —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã–π, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞/—Å—Ç—É–¥–∏–∏/–±–∏–∑–Ω–µ—Å–∞.
- 10‚Äì19: –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –ø—Ä–æ–¥—É–∫—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
- 5‚Äì9: —Ä—è–¥–æ–≤–æ–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (–¥–∏–∑–∞–π–Ω–µ—Ä, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥ –∏ —Ç.–ø.).
- 0‚Äì4: —Å—Ç—É–¥–µ–Ω—Ç, –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –±–µ–∑ —è–≤–Ω–æ–π —Å–≤—è–∑–∏ —Å –±–∏–∑–Ω–µ—Å–æ–º.

3) –¶–∏—Ñ—Ä–æ–≤–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å –∏ —è–≤–Ω–∞—è –Ω—É–∂–¥–∞ (0‚Äì25)
- 20‚Äì25: –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–∞–π—Ç–∞, –ª–µ–Ω–¥–∏–Ω–≥–æ–≤, –∑–∞—è–≤–æ–∫, —Ç—Ä–∞—Ñ–∏–∫–∞, —Ä–µ–∫–ª–∞–º—ã, –≤–æ—Ä–æ–Ω–æ–∫, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –æ–Ω–ª–∞–π–Ω‚Äë–ø—Ä–æ–¥–∞–∂.
- 12‚Äì19: –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–Ω–ª–∞–π–Ω‚Äë–∫–∞–Ω–∞–ª—ã (Telegram‚Äë–∫–∞–Ω–∞–ª –±–∏–∑–Ω–µ—Å–∞, –æ–Ω–ª–∞–π–Ω‚Äë–∫—É—Ä—Å—ã, –≤–µ–±–∏–Ω–∞—Ä—ã, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç).
- 5‚Äì11: –ø—Ä–æ—Å—Ç–æ —Å—É—Ö–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –±–µ–∑ –∞–∫—Ü–µ–Ω—Ç–∞ –Ω–∞ –æ–Ω–ª–∞–π–Ω–µ.
- 0‚Äì4: –æ–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

4) –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –±—é–¥–∂–µ—Ç–∞ / —Ä–∞–∑–º–µ—Ä–∞ (0‚Äì15)
- 12‚Äì15: –∑–∞–º–µ—Ç–Ω–æ, —á—Ç–æ –±–∏–∑–Ω–µ—Å —Å –¥–µ–Ω—å–≥–∞–º–∏ (–∞–≥–µ–Ω—Ç—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π, e‚Äëcommerce, b2b‚Äë—É—Å–ª—É–≥–∏ —Å –≤—ã—Å–æ–∫–∏–º —á–µ–∫–æ–º).
- 7‚Äì11: –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –º–∞–ª—ã–π –±–∏–∑–Ω–µ—Å/—ç–∫—Å–ø–µ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –º–æ–∂–µ—Ç –∑–∞–ø–ª–∞—Ç–∏—Ç—å –∑–∞ —Å–∞–π—Ç/–ª–∏–¥–≥–µ–Ω.
- 3‚Äì6: –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π –∏–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∞—á–∏–Ω–∞—é—â–∏–π –ø—Ä–æ–µ–∫—Ç.
- 0‚Äì2: —Ö–æ–±–±–∏, –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.

5) –ì–µ–æ –∏ —è–∑—ã–∫ (0‚Äì5)
- 4‚Äì5: –≤–∏–¥–Ω–æ, —á—Ç–æ —ç—Ç–æ RU / –°–ù–ì (—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫, –≥–æ—Ä–æ–¥–∞ –†–§/–°–ù–ì, —Ä—É–±–ª–∏).
- 2‚Äì3: —è–∑—ã–∫ —Ä—É—Å—Å–∫–∏–π, –Ω–æ –≥–µ–æ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ.
- 0‚Äì1: –¥—Ä—É–≥–æ–π —Ä—ã–Ω–æ–∫ –∏ —è–∑—ã–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

–®—Ç—Ä–∞—Ñ—ã:
- –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ –ø–æ–ª–∏—Ç–∏–∫—É, —Å—Ç–∞–≤–∫–∏, –∫–∞–∑–∏–Ω–æ, –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–π —Å–∫–∞–º –∏–ª–∏ –Ω–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è ‚Äî –≤—ã—á—Ç–∏ 20 –±–∞–ª–ª–æ–≤.
- –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å—Ç–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π/–ª–∏—á–Ω—ã–π –±–ª–æ–≥ –±–µ–∑ —Å–≤—è–∑–∏ —Å –±–∏–∑–Ω–µ—Å–æ–º ‚Äî –≤—ã—á—Ç–∏ 10 –±–∞–ª–ª–æ–≤.

–°–ª–æ–∂–∏ –≤—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã, –ø—Ä–∏–º–µ–Ω–∏ —à—Ç—Ä–∞—Ñ—ã. –ï—Å–ª–∏ –∏—Ç–æ–≥ <1 ‚Äî —Å–¥–µ–ª–∞–π 1. –ï—Å–ª–∏ >100 ‚Äî —Å–¥–µ–ª–∞–π 100.

–û–¢–í–ï–¢: –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ–¥–Ω–æ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100 –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
–ü—Ä–∏–º–µ—Ä: 87

–°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:
{users_text}

–û–¢–í–ï–¢: –í—ã–¥–∞–π JSON –º–∞—Å—Å–∏–≤ –¢–û–õ–¨–ö–û —Å index –∏ score, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π:
[
  {{"index": 1, "score": 85}},
  {{"index": 2, "score": 72}},
  ...
  {{"index": {batch_size}, "score": 65}}
]"""

    print(f"üì§ –ë–∞—Ç—á #{batch_number}: –æ—Ç–ø—Ä–∞–≤–ª—è—é {batch_size} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
    print(f"   –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}")
    
    try:
        model = genai.GenerativeModel(MODEL)
        response = model.generate_content(prompt)
        
        if hasattr(response, 'text'):
            text = response.text.strip()
        else:
            print("   ‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            return None
        
        # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        json_match = re.search(r'\[.*\]', text, re.DOTALL)
        
        if not json_match:
            print(f"   ‚ùå JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ")
            return None
        
        json_str = json_match.group(0)
        scores_array = json.loads(json_str)
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä—å {index: score}
        scores_dict = {}
        for item in scores_array:
            idx = item.get('index')
            score = item.get('score')
            if idx and score:
                scores_dict[idx - 1] = int(score)  # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ 0-based –∏–Ω–¥–µ–∫—Å
        
        print(f"   ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(scores_dict)} –æ—Ü–µ–Ω–æ–∫\n")
        
        return scores_dict
        
    except json.JSONDecodeError as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}\n")
        return None
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {str(e)}\n")
        return None


# ============ –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ============
def main():
    print("=" * 75)
    print("–ë–ê–¢–ß –°–ò–°–¢–ï–ú–ê –û–¶–ï–ù–ö–ò –õ–ò–î–û–í")
    print("–ü–æ 180 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ")
    print("=" * 75 + "\n")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    print("üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
    file_path = 'users_copy.xlsx'
    df = pd.read_excel(file_path)
    print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n")
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ MAX_USERS –∑–∞–¥–∞–Ω
    if MAX_USERS is not None:
        df = df.head(MAX_USERS).copy()
    
    print(f"üìå –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º {len(df)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    print(f"üìä –ë–∞—Ç—á–µ–π: {(len(df) + BATCH_SIZE - 1) // BATCH_SIZE}\n")
    
    if '–ò–Ω—Ç–µ—Ä–µ—Å' not in df.columns:
        df['–ò–Ω—Ç–µ—Ä–µ—Å'] = None
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–∞—Ç—á–∏
    # 2. –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ù–ï–æ—Ü–µ–Ω—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    work_df = df[df['–ò–Ω—Ç–µ—Ä–µ—Å'].isna()].reset_index().rename(columns={'index': 'orig_idx'})

    print(f"üìå –ù–µ–æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(work_df)}")
    total_batches = (len(work_df) + BATCH_SIZE - 1) // BATCH_SIZE
    all_scores = {}
    api_requests = 0

    print("=" * 75)
    print("–ó–ê–ü–†–û–°–´ –ö API")
    print("=" * 75 + "\n")

    start_time = datetime.now()

    for batch_num in range(total_batches):
        start_idx = batch_num * BATCH_SIZE
        end_idx = min(start_idx + BATCH_SIZE, len(work_df))

        batch_df = work_df.iloc[start_idx:end_idx]
        batch_data = batch_df[['–ò–º—è', '–§–∞–º–∏–ª–∏—è', '–°—É–º–º–∞—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ']].to_dict('records')

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞—Ç—á
        scores = score_batch_users(batch_data, batch_num + 1)
        api_requests += 1

        if scores is None:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –±–∞—Ç—á–∞ {batch_num + 1}")
            continue

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏: —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ –∏—Å—Ö–æ–¥–Ω—ã–π df –ø–æ orig_idx
        for rel_idx, score in scores.items():
            if rel_idx >= len(batch_df):
                continue
            orig_idx = int(batch_df.iloc[rel_idx]['orig_idx'])
            df.at[orig_idx, '–ò–Ω—Ç–µ—Ä–µ—Å'] = score
            all_scores[orig_idx] = score

        if batch_num < total_batches - 1:
            time.sleep(1)

    elapsed = (datetime.now() - start_time).total_seconds()
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å—É
    df = df.sort_values('–ò–Ω—Ç–µ—Ä–µ—Å', ascending=False, na_position='last').reset_index(drop=True)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("\n" + "=" * 75)
    print("–°–¢–ê–¢–ò–°–¢–ò–ö–ê")
    print("=" * 75 + "\n")
    
    scored = df[df['–ò–Ω—Ç–µ—Ä–µ—Å'].notna()]
    not_scored = df[df['–ò–Ω—Ç–µ—Ä–µ—Å'].isna()]
    
    print(f"‚è±Ô∏è  –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {elapsed:.1f} —Å–µ–∫ ({elapsed/60:.2f} –º–∏–Ω)")
    print(f"üì° API –∑–∞–ø—Ä–æ—Å–æ–≤: {api_requests}")
    print(f"üë• –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(scored)}")
    print(f"‚ùå –û—à–∏–±–æ–∫: {len(not_scored)}\n")
    
    if len(scored) > 0:
        hot = len(scored[scored['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 80])
        warm = len(scored[(scored['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 50) & (scored['–ò–Ω—Ç–µ—Ä–µ—Å'] < 80)])
        cold = len(scored[(scored['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 20) & (scored['–ò–Ω—Ç–µ—Ä–µ—Å'] < 50)])
        not_interested = len(scored[scored['–ò–Ω—Ç–µ—Ä–µ—Å'] < 20])
        
        total = len(scored)
        print(f"üî• –ì–û–†–Ø–ß–ò–ï (80-100):      {hot:3d} ({hot*100//total:2d}%)")
        print(f"üü° –¢–ï–ü–õ–´–ï (50-79):       {warm:3d} ({warm*100//total:2d}%)")
        print(f"‚ùÑÔ∏è  –•–û–õ–û–î–ù–´–ï (20-49):     {cold:3d} ({cold*100//total:2d}%)")
        print(f"‚ùå –ù–ï–ò–ù–¢–ï–†–ï–°–ù–´–ï (1-19):  {not_interested:3d} ({not_interested*100//total:2d}%)")
        print(f"\n{'‚îÄ' * 75}")
        print(f"üìà –í–°–ï–ì–û: {total}\n")
    
    # –¢–û–ü –ª–∏–¥–æ–≤
    print("=" * 75)
    print("üî• –¢–û–ü-20 –ì–û–†–Ø–ß–ò–• –õ–ò–î–û–í")
    print("=" * 75 + "\n")
    
    top_leads = df[df['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 80].head(20)
    
    if len(top_leads) > 0:
        for i, (idx, row) in enumerate(top_leads.iterrows(), 1):
            # –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º NaN
            name = str(row['–ò–º—è']) if pd.notna(row['–ò–º—è']) else ''
            surname = str(row['–§–∞–º–∏–ª–∏—è']) if pd.notna(row['–§–∞–º–∏–ª–∏—è']) else ''
            username = str(row['–Æ–∑–µ—Ä–Ω–µ–π–º']) if pd.notna(row['–Æ–∑–µ—Ä–Ω–µ–π–º']) else ''

            print(
                f"{i:2d}. "
                f"[{row['–ò–Ω—Ç–µ—Ä–µ—Å']:3.0f}] "
                f"{name:15} "
                f"{surname:15} "
                f"@{username.replace('@', '')}"
            )
    else:
        print("–ì–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    
    # –°–û–•–†–ê–ù–ï–ù–ò–ï
    print("\n" + "=" * 75)
    print("üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í")
    print("=" * 75 + "\n")
    
    # 1. Excel
    output_excel = 'batch_results_scored.xlsx'
    df.to_excel(output_excel, index=False)
    print(f"‚úÖ Excel: {output_excel}")
    
    # 2. JSON
    json_data = {
        "metadata": {
            "total_users": len(scored),
            "generated_at": datetime.now().isoformat(),
            "model": MODEL,
            "processing_time_seconds": elapsed,
            "api_requests": api_requests,
            "batch_mode": True,
            "batch_size": BATCH_SIZE,
            "distribution": {
                "hot": len(scored[scored['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 80]) if len(scored) > 0 else 0,
                "warm": len(scored[(scored['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 50) & (scored['–ò–Ω—Ç–µ—Ä–µ—Å'] < 80)]) if len(scored) > 0 else 0,
                "cold": len(scored[(scored['–ò–Ω—Ç–µ—Ä–µ—Å'] >= 20) & (scored['–ò–Ω—Ç–µ—Ä–µ—Å'] < 50)]) if len(scored) > 0 else 0,
                "not_interested": len(scored[scored['–ò–Ω—Ç–µ—Ä–µ—Å'] < 20]) if len(scored) > 0 else 0,
            }
        },
        "users": []
    }
    
    for i, row in scored.iterrows():
        json_data["users"].append({
            "rank": len(json_data["users"]) + 1,
            "score": int(row['–ò–Ω—Ç–µ—Ä–µ—Å']),
            "id": str(row['ID']),
            "name": str(row['–ò–º—è']).strip(),
            "surname": str(row['–§–∞–º–∏–ª–∏—è']).strip(),
            "username": str(row['–Æ–∑–µ—Ä–Ω–µ–π–º']).strip(),
            "description": str(row['–°—É–º–º–∞—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ']).strip()[:150],
            "is_premium": str(row['–ü—Ä–µ–º–∏—É–º']).strip() == '–î–∞',
            "collection_date": str(row['–î–∞—Ç–∞ —Å–±–æ—Ä–∞']).strip()
        })
    
    output_json = 'batch_hot_leads.json'
    with open(output_json, 'w', encoding='utf-8') as f:
        json.dump(json_data, f, ensure_ascii=False, indent=2)
    print(f"‚úÖ JSON: {output_json}")
    
    # 3. CSV
    csv_output = 'batch_hot_leads_export.csv'
    df_export = df[['–ò–º—è', '–§–∞–º–∏–ª–∏—è', '–Æ–∑–µ—Ä–Ω–µ–π–º', '–ò–Ω—Ç–µ—Ä–µ—Å', '–°—É–º–º–∞—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', '–ü—Ä–µ–º–∏—É–º']]
    df_export.to_csv(csv_output, index=False, encoding='utf-8-sig')
    print(f"‚úÖ CSV: {csv_output}\n")
    
    # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    print("=" * 75)
    print("‚ú® –ì–û–¢–û–í–û!")
    print("=" * 75)
    print(f"""
üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:
   ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(scored)}
   ‚Ä¢ API –∑–∞–ø—Ä–æ—Å–æ–≤: {api_requests}
   ‚Ä¢ –í—Ä–µ–º—è: {elapsed/60:.2f} –º–∏–Ω—É—Ç
   ‚Ä¢ –ú–æ–¥–µ–ª—å: {MODEL}

üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:
   1. –û—Ç–∫—Ä–æ–π {output_json}
   2. –ù–∞—á–Ω–∏ –ø–∏—Å–∞—Ç—å –≥–æ—Ä—è—á–∏–º –ª–∏–¥–∞–º (—Å–∫–æ—Ä >= 80)
   3. –ò—Å–ø–æ–ª—å–∑—É–π {output_excel} –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ Excel

üí° –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:

   # Python
   import json
   with open('{output_json}') as f:
       leads = json.load(f)
   
   # –í—Å–µ –≥–æ—Ä—è—á–∏–µ
   hot = [u for u in leads['users'] if u['score'] >= 80]
   print(f"–ì–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤: {{len(hot)}}")

üöÄ API —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {api_requests} –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ {len(scored)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!
""")


if __name__ == "__main__":
    main()
